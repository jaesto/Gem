<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' blob:; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self';"
    />
    <title>Gem</title>
      <meta property="og:title" content="Gem" />
      <link rel="icon" href="./assets/favicon.png?v=2" type="image/png" sizes="32x32" />
      <link rel="apple-touch-icon" href="./assets/favicon.png?v=2" />
      <meta property="og:image" content="./assets/gem-logo.png?v=2" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <!-- Skip to main content link for keyboard users -->
    <a href="#graph" class="skip-link">Skip to graph</a>

    <!-- Screen reader announcements -->
    <div id="sr-announcements" class="visually-hidden" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Top navigation bar with workbook controls, layouts, filters, exports, and theme toggle -->
    <header class="topbar" role="banner">
      <div class="left">
        <a class="brand" href="./">
          <img id="brandLogo"
               src="/Gem/assets/gem-logo.png?v=4"
               alt="Gem" width="28" height="28" />
          <span class="brand-name">Gem</span>
        </a>
        <button class="btn" id="openBtn" type="button">Open Workbook</button>
      </div>
      <div class="center">
        <form id="search-form" role="search">
          <label for="search" class="visually-hidden">Search nodes</label>
          <input id="search" name="q" type="search" placeholder="Search..." list="node-names" autocomplete="off" />
          <datalist id="node-names"></datalist>
        </form>
      </div>
      <div class="right">
        <button class="btn" id="undoBtn" type="button" title="Undo layout change" disabled>↶ Undo</button>
        <button class="btn" id="redoBtn" type="button" title="Redo layout change" disabled>↷ Redo</button>
        <button class="btn" id="fitBtn" type="button" title="Zoom to the visible graph">Fit</button>
        <button class="btn" id="layoutBtn" type="button" title="Re-run the layout to spread nodes">Auto layout</button>
        <div class="dropdown" id="layoutDropdown">
          <button
            id="layoutMenuBtn"
            class="btn"
            title="Choose layout"
            aria-haspopup="true"
            aria-expanded="false"
          >
            Layout: Auto ▾
          </button>
          <div id="layoutMenu" class="menu" role="menu" aria-label="Layout menu">
            <button class="menu-item" data-layout="force" role="menuitem">Force</button>
            <button class="menu-item" data-layout="grid" role="menuitem">Grid</button>
            <button class="menu-item" data-layout="hierarchy" role="menuitem">Hierarchy</button>
            <button class="menu-item" data-layout="centered" role="menuitem">Centered hierarchy</button>
            <button class="menu-item" data-layout="centered-selection" role="menuitem">Centered from selection</button>
          </div>
        </div>
        <label for="hopBtn" class="visually-hidden">Expand neighbors hops</label>
        <div class="dropdown" id="hopDropdown">
          <button id="hopBtn" class="btn" type="button" title="Choose neighbor expansion">Hops ▾</button>
          <div id="hopMenu" class="menu" role="menu" aria-label="Hop menu">
            <button class="menu-item" data-hop="1" role="menuitem">1 hop</button>
            <button class="menu-item" data-hop="2" role="menuitem">2 hops</button>
            <button class="menu-item" data-hop="3" role="menuitem">3 hops</button>
            <button class="menu-item" data-hop="4" role="menuitem">4 hops</button>
            <button class="menu-item" data-hop="5" role="menuitem">5 hops</button>
          </div>
        </div>
        <div class="dropdown" id="isolatedDropdown">
          <button
            id="isolatedBtn"
            class="btn"
            type="button"
            title="Control isolated nodes"
          >
            Isolated ▾
          </button>
          <div id="isolatedMenu" class="menu">
            <button class="menu-item" type="button" data-iso="hide">Hide</button>
            <button class="menu-item" type="button" data-iso="cluster">Cluster</button>
            <button class="menu-item" type="button" data-iso="scatter">Scatter</button>
            <button class="menu-item" type="button" data-iso="unhide">Unhide</button>
          </div>
        </div>
        <!-- Filter dropdown for node type toggles -->
        <details class="dropdown" id="filters-dropdown">
          <summary>Filters</summary>
          <div class="menu">
            <label><input type="checkbox" data-filter="Field" checked /> Fields</label>
            <label><input type="checkbox" data-filter="CalculatedField" checked /> Calculated</label>
            <label><input type="checkbox" data-filter="Worksheet" checked /> Worksheets</label>
            <label><input type="checkbox" data-filter="Dashboard" checked /> Dashboards</label>
            <label><input type="checkbox" data-filter="Parameter" checked /> Parameters</label>
            <hr />
            <label><input type="checkbox" data-filter="lodOnly" /> LOD only</label>
            <label><input type="checkbox" data-filter="tableCalcOnly" /> Table Calcs only</label>
            <hr />
            <label><input type="checkbox" data-filter="datatype-string" checked /> String types</label>
            <label><input type="checkbox" data-filter="datatype-number" checked /> Number types</label>
            <label><input type="checkbox" data-filter="datatype-date" checked /> Date types</label>
            <label><input type="checkbox" data-filter="datatype-boolean" checked /> Boolean types</label>
          </div>
        </details>
        <!-- Export dropdown for documentation downloads -->
        <details class="dropdown" id="export-dropdown">
          <summary>Export</summary>
          <div class="menu">
            <button class="btn" type="button" data-export="workbook-json">workbook_doc.json</button>
            <button class="btn" type="button" data-export="graph-json">graph.json</button>
            <button class="btn" type="button" data-export="markdown">workbook_doc.md</button>
            <button class="btn" type="button" data-export="dot">lineage.dot</button>
          </div>
        </details>
        <button class="btn" id="themeBtn" type="button" aria-pressed="true">Dark</button>
      </div>
    </header>

    <!-- Main layout: sidebar lists, graph canvas, and details panel -->
    <main class="layout" role="main">
      <!-- Sidebar with drop zone and workbook navigation tabs -->
      <aside class="sidebar">
        <section id="dropZone" class="dropzone" aria-label="Workbook drop zone" tabindex="0">
          <!-- Loader wiring expects this stable ID (see ID invariants in app.js). -->
          <input id="fileInput" type="file" accept=".twb,.twbx" hidden />
          <p>Drop a Tableau .twb or .twbx file here<br />or click Open Workbook.</p>
        </section>
        <!-- Sidebar tabs allow switching between node, sheet, calc, and parameter lists -->
        <nav class="tabs" aria-label="Sidebar tabs">
          <button type="button" data-tab="panel-nodes" class="tab active">Nodes</button>
          <button type="button" data-tab="panel-sheets" class="tab">Sheets</button>
          <button type="button" data-tab="panel-calcs" class="tab">Calcs</button>
          <button type="button" data-tab="panel-params" class="tab">Params</button>
        </nav>
        <section id="panel-nodes" class="tab-panel active" aria-live="polite">
          <ul id="list-nodes"></ul>
        </section>
        <section id="panel-sheets" class="tab-panel" aria-live="polite">
          <ul id="list-sheets"></ul>
        </section>
        <section id="panel-calcs" class="tab-panel" aria-live="polite">
          <ul id="list-calcs"></ul>
        </section>
        <section id="panel-params" class="tab-panel" aria-live="polite">
          <ul id="list-params"></ul>
        </section>
      </aside>

      <!-- Cytoscape graph container and status overlay -->
      <section class="graphwrap" role="region" aria-label="Graph visualization">
        <div id="graph" aria-label="Workbook dependency graph" role="img" tabindex="0"></div>
        <div id="status" class="status" role="status" aria-live="polite">No workbook loaded.</div>
      </section>

      <!-- Details pane surfaces metadata for the selected node -->
      <aside class="details" id="details" role="complementary" aria-label="Node details" aria-live="polite" aria-atomic="false">
        <h2>No selection</h2>
        <p>Load a workbook and choose a node to see details.</p>
      </aside>
    </main>

    <footer class="status-bar" role="contentinfo">
      <span id="footer-info"></span>
    </footer>

    <div id="errOverlay"></div>
    <div id="edge-tooltip" class="edge-tooltip"></div>

    <script src="./lib/jszip.min.js"></script>
    <script src="./lib/cytoscape.min.js"></script>
    <script src="./lib/cytoscape-cose-bilkent.min.js"></script> <!-- keep if present -->
    <script type="module" src="./src/main.js"></script>
  </body>
</html>
